import gradio as gr
import time
from rag_module import get_answer, save_new_qa, reset_data

DATA_PATH = "answers.json"

# --- Hi·ªáu ·ª©ng g√µ ch·ªØ ---
def typewriter_effect(text):
    result = ""
    for ch in text:
        result += ch
        time.sleep(0.015)
        yield result

# --- CSS gi·ªØ nguy√™n nh∆∞ng c·∫≠p nh·∫≠t n√∫t dark/light ---
custom_css = """
/* C√°c style chat, user/assistant gi·ªØ nguy√™n */
.message.user { ... }
.message.assistant { ... }
/* ... c√°c style kh√°c ... */

/* N√∫t dark/light üåô */
#toggle-btn {
    position: fixed;        
    top: 10px;               
    right: 10px;            
    z-index: 9999;
    background-color: #f0f0f0;
    color: #333;
    border: none;
    border-radius: 50%;
    width: 50px;            
    height: 50px;           
    font-size: 22px;        
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: background-color 0.3s ease, transform 0.2s ease;
}

#toggle-btn:hover { 
    transform: scale(1.1); 
}

body.dark-mode #toggle-btn { 
    background-color: #333; 
    color: #f5f5f5; 
}
"""

# --- JS toggle dark mode gi·ªØ nguy√™n ---
toggle_js = """
<script>
let isDark = false;
function toggleTheme() {
  isDark = !isDark;
  if (isDark) {
    document.body.classList.add('dark-mode');
  } else {
    document.body.classList.remove('dark-mode');
  }
}
</script>
"""


with gr.Blocks(css=custom_css, theme=gr.themes.Soft()) as demo:
    gr.HTML(toggle_js)
    gr.HTML("<button id='toggle-btn' onclick='toggleTheme()'>üåô</button>")
    gr.Markdown("## üí¨ Chatbot To√°n R·ªùi R·∫°c 2 ‚Äî PTIT Assistant")

    chatbot = gr.Chatbot(type="messages", height=420)

    with gr.Row():
        msg = gr.Textbox(
            placeholder="Nh·∫≠p c√¢u h·ªèi To√°n R·ªùi R·∫°c...",
            show_label=False,
            lines=1,
            max_lines=3,
            scale=4
        )
        send_btn = gr.Button("üì§ G·ª≠i", scale=1)
        clear_btn = gr.Button("üßπ X√≥a", scale=1)
        reset_btn = gr.Button("üîÑ Reset", scale=1)

    unknown_question = gr.State("")

    # --- Ph·∫£n h·ªìi chatbot ---
    def respond(message, chat_history, unknown_q):
        if not message.strip():
            return "", chat_history, unknown_q

        if unknown_q:
            chat_history.append({"role": "user", "content": message})
            save_new_qa(unknown_q, message, DATA_PATH)
            chat_history.append({"role": "assistant", "content": ""})
            text_to_show = f"C·∫£m ∆°n! M√¨nh ƒë√£ h·ªçc xong c√¢u tr·∫£ l·ªùi m·ªõi: {message}"
            for partial in typewriter_effect(text_to_show):
                chat_history[-1]["content"] = partial
                yield "", chat_history, ""
            unknown_q = ""
            return

        chat_history.append({"role": "user", "content": message})
        reply = get_answer(message)

        if reply == "Xin l·ªói, m√¨nh ch∆∞a c√≥ th√¥ng tin v·ªÅ c√¢u h·ªèi n√†y.":
            unknown_q = message
            chat_history.append({"role": "assistant", "content": "M√¨nh ch∆∞a bi·∫øt c√¢u n√†y. B·∫°n c√≥ th·ªÉ cho m√¨nh bi·∫øt c√¢u tr·∫£ l·ªùi kh√¥ng?"})
            yield "", chat_history, unknown_q
            return

        chat_history.append({"role": "assistant", "content": ""})
        for partial in typewriter_effect(reply):
            chat_history[-1]["content"] = partial
            yield "", chat_history, unknown_q

    # --- S·ª± ki·ªán ---
    msg.submit(respond, [msg, chatbot, unknown_question], [msg, chatbot, unknown_question])
    send_btn.click(respond, [msg, chatbot, unknown_question], [msg, chatbot, unknown_question])
    clear_btn.click(lambda: [], None, chatbot, queue=False)


    # --- Reset d·ªØ li·ªáu nh∆∞ng gi·ªØ chat ---
    def reset_and_notify(chat_history):
        reset_data()  # reset file JSON + embeddings
        # th√™m message th√¥ng b√°o v√†o chat hi·ªán t·∫°i
        chat_history.append({
            "role": "assistant",
            "content": "M√¨nh ƒë√£ x√≥a t·∫•t c·∫£ nh·ªØng g√¨ ƒë√£ h·ªçc!"
        })
        return chat_history


    reset_btn.click(
        reset_and_notify,
        inputs=[chatbot],
        outputs=[chatbot]
    )

demo.launch()
